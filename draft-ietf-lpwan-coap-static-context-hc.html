<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" 
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html lang="en" xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head profile="http://www.w3.org/2006/03/hcard http://dublincore.org/documents/2008/08/04/dc-html/">
  <meta http-equiv="Content-Type" content="text/html; charset=us-ascii" />

  <title>6LPWA Static Context Header Compression (SCHC) for CoAP</title>

  
<style type="text/css">/*<![CDATA[*/
@viewport {
  zoom: 1.0;
  width: extend-to-zoom;
}
@-ms-viewport {
  width: extend-to-zoom;
  zoom: 1.0;
}

@media screen and (min-width: 1024px) {
  ul.toc, #rfc\.toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 500px);
    width: 300px;
    padding: 0 1em;
    z-index: 1;
  }
  #rfc\.toc {
    top: 16px;
  }
  ul.toc {
    top: 80px;
    overflow: auto;
  }

  body {
    padding-left: 1.5em;
    padding-right: 29em;
  }
}

body {
  font: 15px "Helvetica Neue",Helvetica,Arial,sans-serif;
  color: #333;
  font-size-adjust: 0.5;
  line-height: 130%;
  margin: 2.5em auto;
  max-width: 724px;
}

.title, .filename, h1, h2, h3, h4 {
  font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
  font-size-adjust: 0.5;
  font-weight: 500;
  color: #333;
  line-height: 100%;
  margin: 0.8em 0 0.3em;
}
.title { font-size: 36px; }
h1 { font-size: 30px; }
h2 { font-size: 24px; }
h3, h4 { font-size: 18px; }
h1 a[href], h2 a[href], h3 a[href], h4 a[href] {
  color: #333;
}

ul.toc li {
  list-style: none;
  text-indent: -2.5em;
  padding-left: 2.5em;
  padding-bottom: 5px;
  margin: 0;
}
ul.toc ul {
  margin: 0;
}
/* xml2rfc nests ul directly inside ul which messes with the style badly */
ul.toc, ul.toc>ul, ul.toc ul>ul {
  margin: 0 0 0 1.5em;
}

table {
  margin-left: 0em;
  border-collapse: collapse;
}
th {
  text-align: left;
  border-bottom: 2px solid #ddd;
}
td {
  border-top: 1px solid #ddd;
  vertical-align: top;
}
tr:nth-child(2n+1) > td,
tr:nth-child(2n+1) > th {
  background-color: #f9f9f9;
}
td.reference {
  max-width: 200px;
  border-top: none;
  padding-right: 1em;
}
.right {
  text-align: right;
}


table.header {
  width: 100%;
}
table.header td {
  border: none;
  background-color: transparent;
  color: black;
}
.filename {
  color: rgb(119, 119, 119);
  font-size: 23px;
  font-weight: normal;
  height: auto;
  line-height: 100%;
}
#rfc\.abstract+p {
  font-size: 20px;
  font-weight: 300;
  line-height: 130%;
}

samp, tt, code, pre {
  font: 11pt consolas, monospace;
  font-size-adjust: none;
}
pre {
  background-color: #eee;
  border: 1px solid #ddd;
  overflow-x: auto;
  padding: 5px;
  margin: 5px;
}
.figure {
  font-style: italic;
  margin: 0 1.5em;
}

address {
  margin: 10px 0 0;
}
.vcard {
  font-style: normal;
}
.vcardline {
  display: block;
}
.vcardline .fn {
  font-weight: bold;
}
.vcardline .hidden {
  display: none;
}

dl {
  margin-left: 1em;
}
dl.dl-horizontal: {
  margin-left: 0;
}
dl > dt {
  float: left;
  margin-right: 1em;
}
dl.nohang > dt {
  float: none;
}
dl > dd {
  margin-bottom: .5em;
}
dl.compact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}
ul.empty {
  list-style-type: none;
}
ul.empty li {
  margin-top: .5em;
}

hr {
  border: 0;
  border-top: 1px solid #eee;
}

a {
  text-decoration: none;
}
a[href] {
  color: #2a6496;
}
a[href]:hover {
  background-color: #eee;
}

ol, ul, li, p {
  padding: 0;
  margin: 0.5em 0 0.5em 2em;
}
li, p {
  margin-left: 0;
}
address {
  font-style: normal;
}

.github-fork-ribbon-wrapper {
  display: none;
}
@media screen and (min-width: 800px) {
  /* "Fork me on GitHub" CSS ribbon based on
   * https://github.com/simonwhitaker/github-fork-ribbon-css
   */
  .github-fork-ribbon {
    position: absolute;
    padding: 2px 0;
    background-color: #a00;
    background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));
    box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);
    font: 700 12px "Helvetica Neue", Helvetica, Arial, sans-serif;

    pointer-events: auto;

    top: 38px;
    right: -45px;

    transform: rotate(45deg);
  }

  .github-fork-ribbon a[href],
  .github-fork-ribbon a[href]:hover {
    color: #fff;
    background-color: transparent;
    text-decoration: none;
    text-shadow: 0 -1px rgba(0, 0, 0, 0.5);
    text-align: center;

    width: 190px;
    line-height: 18px;

    display: inline-block;
    padding: 2px 0;

    border: 1.5px dotted #fff;
    border-color: rgba(255, 255, 255, 0.6);
  }

  .github-fork-ribbon-wrapper {
    display: block;
    width: 130px;
    height: 130px;
    position: absolute;
    overflow: hidden;
    top: 0; right: 0;
    z-index: 2;
    pointer-events: none;
  }
}
@media screen and (min-width: 1000px) {
  .github-fork-ribbon-wrapper {
    position: fixed;
  }
/*]]>*/</style>


  <link href="#rfc.toc" rel="Contents"/>
<link href="#rfc.section.1" rel="Chapter" title="1 Introduction"/>
<link href="#rfc.section.2" rel="Chapter" title="2 Compressing CoAP"/>
<link href="#rfc.section.2.1" rel="Chapter" title="2.1 CoAP usages"/>
<link href="#rfc.section.2.2" rel="Chapter" title="2.2 CoAP protocol analysis"/>
<link href="#rfc.section.2.2.1" rel="Chapter" title="2.2.1 CoAP Compression Decompression Function"/>
<link href="#rfc.section.2.2.2" rel="Chapter" title="2.2.2 CoAP mandatory header"/>
<link href="#rfc.section.2.2.3" rel="Chapter" title="2.2.3 Examples of CoAP header compression"/>
<link href="#rfc.references" rel="Chapter" title="3 Normative References"/>
<link href="#rfc.authors" rel="Chapter"/>


  <meta name="generator" content="xml2rfc version 2.5.2 - http://tools.ietf.org/tools/xml2rfc" />
  <link rel="schema.dct" href="http://purl.org/dc/terms/" />

  <meta name="dct.creator" content="Minaburo, A. and L. Toutain" />
  <meta name="dct.identifier" content="urn:ietf:id:draft-ietf-lpwan-coap-static-context-hc-latest" />
  <meta name="dct.issued" scheme="ISO8601" content="2016-12" />
  <meta name="dct.abstract" content="This draft discusses the way SCHC can be applied to CoAP headers and extend the number of  functions (CDF) to optimize compression." />
  <meta name="description" content="This draft discusses the way SCHC can be applied to CoAP headers and extend the number of  functions (CDF) to optimize compression." />

</head>

<body>

  <table class="header">
    <tbody>
    
    	<tr>
  <td class="left">lpwan Working Group</td>
  <td class="right">A. Minaburo</td>
</tr>
<tr>
  <td class="left">Internet-Draft</td>
  <td class="right">Acklio</td>
</tr>
<tr>
  <td class="left">Intended status: Informational</td>
  <td class="right">L. Toutain</td>
</tr>
<tr>
  <td class="left">Expires: June 4, 2017</td>
  <td class="right">Institut MINES TELECOM ; TELECOM Bretagne</td>
</tr>
<tr>
  <td class="left"></td>
  <td class="right">December 2016</td>
</tr>

    	
    </tbody>
  </table>

  <p class="title">6LPWA Static Context Header Compression (SCHC) for CoAP<br />
  <span class="filename">draft-ietf-lpwan-coap-static-context-hc-latest</span></p>
  
  <h1 id="rfc.abstract">
  <a href="#rfc.abstract">Abstract</a>
</h1>
<p>This draft discusses the way SCHC can be applied to CoAP headers and extend the number of  functions (CDF) to optimize compression.</p>
<h1 id="rfc.status">
  <a href="#rfc.status">Status of This Memo</a>
</h1>
<p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p>
<p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF).  Note that other groups may also distribute working documents as Internet-Drafts.  The list of current Internet-Drafts is at http://datatracker.ietf.org/drafts/current/.</p>
<p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time.  It is inappropriate to use Internet-Drafts as reference material or to cite them other than as "work in progress."</p>
<p>This Internet-Draft will expire on June 4, 2017.</p>
<h1 id="rfc.copyrightnotice">
  <a href="#rfc.copyrightnotice">Copyright Notice</a>
</h1>
<p>Copyright (c) 2016 IETF Trust and the persons identified as the document authors.  All rights reserved.</p>
<p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (http://trustee.ietf.org/license-info) in effect on the date of publication of this document.  Please review these documents carefully, as they describe your rights and restrictions with respect to this document.  Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p>
<h1 id="rfc.section.1"><a href="#rfc.section.1">1.</a> <a href="#Introduction" id="Introduction">Introduction</a></h1>
<p><a href="#I-D.toutain-lpwan-ipv6-static-context-hc">[I-D.toutain-lpwan-ipv6-static-context-hc]</a> defines a compression technique for LPWA network based on static context.  This context is said static since the element values composing the context are not learned during packet exchanges but previously installed.  The context is known by both ends.  A context is composed of a set of rules (referenced by rule ids). A rule describes the header fields with some associated Target Values (TV). A Matching Operator (MO) is associated to each field. The rule is selected if all the MO matches . A Compression Decompression Function is associated to each field to define the link between the compressed and decompressed value for a specific field.</p>
<p id="rfc.section.1.p.2">This draft discusses the way SCHC can be applied to CoAP headers and extend the number of  functions (CDF) to optimize compression.</p>
<h1 id="rfc.section.2"><a href="#rfc.section.2">2.</a> <a href="#compressing-coap" id="compressing-coap">Compressing CoAP</a></h1>
<p id="rfc.section.2.p.1">CoAP <a href="#RFC7252">[RFC7252]</a> is an implementation of a the REST architecture for contrained devices. Gateway between CoAP and HTTP can be easily build since both protocol  uses the same address space (URL), caching mechanisms and methods.</p>
<p id="rfc.section.2.p.2">Nevertheless, if limited, the size of a CoAP header may be incompatible with LPWAN constraints and some compression may be needed to reduce the header size. CoAP compression is not straightforward. Some differences between IPv6/UDP and CoAP can be enlighten. CoAP differs from IPv6 and UDP protocols:</p>
<p/>

<ul>
  <li>IPv6 and UDP are symmetrical protocols. The same fields are found in the request and in the answer, only location in the header may change (e.g. source and destination fields). A CoAP request is different from  an answer. For instance, the URI-path option is mandatory in the request and may not be found in the response.</li>
  <li>CoAP also obeys to the client/server paradigm and the compression rate can be different if the request is issued from a LPWAN node or from an external device. For instance in the former case the token size may be set to one byte. In the latter case, the token size cannot be constraint and be up to 15 byte long.</li>
  <li>In IPv6, main header and UDP fields have a fixed size. In CoAP, Token size may vary from 0 to 15 bytes, length is given by a field in the header. More systematically, the options are described using the Type-Length-Value principle.  Evenmore regarding the option size value, the coding will be different.</li>
  <li>options type in CoAP are not defined with the same value. The Delta TLV coding makes that the type is not independant of previous option and may vary regarding the options contained in the header.</li>
</ul>
<h1 id="rfc.section.2.1"><a href="#rfc.section.2.1">2.1.</a> <a href="#coap-usages" id="coap-usages">CoAP usages</a></h1>
<p id="rfc.section.2.1.p.1">A LPWAN node can either be a client or a server and sometimes both.  In the client mode, the LPWAN node sends request to a server and expected answer or acknowledgements. Acknowledgements can be at 2 different levels:</p>
<p/>

<ul>
  <li>transport level, a CON message is acknowledged by an ACK message. NON confirmable messages are not acknowledged.</li>
  <li>REST level, a REST request is acknowledged by an &#8220;error&#8221; code. <a href="#RFC7967">[RFC7967]</a> defines an option to limit the number of acknowledgements.</li>
</ul>
<p id="rfc.section.2.1.p.3">Note that acknowledgement can be optimized and a REST level acknowledgement can be used as a transport level acknowledgement.</p>
<h1 id="rfc.section.2.2"><a href="#rfc.section.2.2">2.2.</a> <a href="#coap-protocol-analysis" id="coap-protocol-analysis">CoAP protocol analysis</a></h1>
<p id="rfc.section.2.2.p.1">CoAP defines the following fields:</p>
<p/>

<ul>
  <li>version (2 bits): this field can be elided during a compresssion</li>
  <li>type (2 bits): defines the type of the transport messages, 4 values are defined.  Regarding the type of exchange, if only NON messages are sent or CON/ACK messages, this field can be reduced to 0 or 1 bit.</li>
  <li>token length (4 bytes). The standard allows up to 15 bytes for a token length.  If a fix token size is chosen, then this field can be elided. If some variation in length are needed then 1 or 2 bits could be enough for most of LPWAN applications.</li>
  <li>code (8 bits). This field codes the request and the response values. CoAP represents in a more compact way, coding used in HTTP, but the coding is not optimal.</li>
  <li>message id (16 bits). This value is used to acknowledge CON frames. The size of this field is computed to allow the anticipation (how many frames can be sent without acknowledgement). When a value is used, <a href="#RFC7252">[RFC7252]</a> defines the time before it can be reused without ambiguities. This size may be too large for a LPWAN node sending or receiving few messages a day.</li>
  <li>Token (0 to 15 bytes). Token identifies active flows. Regarding the usage (stability of in time and limited number), a short token (1 Byte) can be enough.</li>
  <li>options are coded through delta-TLV. The delta-T depends of previous values, length is encoded inside the option. <a href="#RFC7252">[RFC7252]</a> distinguishes repeatable options that can appear several time in the header.  Among them we can distinguish:  <ul><li>list options which appear several time in the header but are exclusive such as the Accept option.</li><li>cumulative options which appear several time in the header but are part of a more generic value such as Uri-Path and Uri-Query.</li></ul><p> For a given flow some value options are stable through time. Observe, ETag, If-Match, If-None-Match and Size varies in each message. Options can be stored in a SCHC context and cumulative options can be stored globally.</p></li>
</ul>
<p id="rfc.section.2.2.p.3">The CoAP protocol must not be altered by the compression/decompression phase, but if no semantic is attributed to a value, it may be changed during this phase. For instance the compression phase may reduce the size of a token but must maintain its unicity. The decompressor will not be able to restore the original value but behavior will remain the same. If no special semantic is assigned to the token, this will be transparent. If a special semantic is assigned to the token, its compression may not be possible.</p>
<p id="rfc.section.2.2.p.4">This implies that the compressor/decompressor must be aware of the protocol state machine and do not processes request and response the same way.</p>
<p id="rfc.section.2.2.p.5">A conservative compression leaves the field value unchanged. Non conservative compression can be used when a CoAP implementation has not been defined to work specifically with LPWAN network and uses large values for fields.</p>
<h1 id="rfc.section.2.2.1"><a href="#rfc.section.2.2.1">2.2.1.</a> <a href="#coap-compression-decompression-function" id="coap-compression-decompression-function">CoAP Compression Decompression Function</a></h1>
<p id="rfc.section.2.2.1.p.1">To compress more efficiently CoAP message, several Compression/Decompression Function (CDF) must be defined.</p>
<h1 id="rfc.section.2.2.1.1"><a href="#rfc.section.2.2.1.1">2.2.1.1.</a> <a href="#static-mapping" id="static-mapping">Static-mapping</a></h1>
<p id="rfc.section.2.2.1.1.p.1">The goal of static-mapping is to reduce the size of a field by allocating shorter value. The mapping is known by both ends and stored in a table in both end context. The Static-mapping is conservative.</p>
<p id="rfc.section.2.2.1.1.p.2">Static-mapping may be applied to several fields. For instance the type field may be reduced from 2 bits to 1 bit if only CON/ACK type is used, but the main benefit is  compressing the code field.</p>
<p id="rfc.section.2.2.1.1.p.3">The CoAP code field defines a tricky way to ensure compatibility with HTTP values. Nevertheless only 21 values are defined by <a href="#RFC7252">[RFC7252]</a> compared to the 255 possible values. So it could efficiently be coded on 5 bits.  To allow flexibility and evolution if new codes are introduced, a static mapping table is associated to each instance of this function.</p>
<p><a href="#Fig-code-mapping">Figure 1</a> gives a possible mapping, it can be changed to add new codes or reduced if some values are never used by both ends.</p>
<div id="rfc.figure.1"/>
<div id="Fig-code-mapping"/>
<pre>
            +------+------------------------------+-----------+
            | Code | Description                  | Mapping   |
            +------+------------------------------+-----------+
            | 0.00 |                              |  0x00     |
            | 0.01 | GET                          |  0x01     |
            | 0.02 | POST                         |  0x02     |
            | 0.03 | PUT                          |  0x03     |
            | 0.04 | DELETE                       |  0x04     |
            | 0.05 | FETCH                        |  0x05     |
            | 0.06 | PATCH                        |  0x06     |
            | 0.07 | iPATCH                       |  0x07     |
            | 2.01 | Created                      |  0x08     |
            | 2.02 | Deleted                      |  0x09     |
            | 2.03 | Valid                        |  0x0A     |
            | 2.04 | Changed                      |  0x0B     |
            | 2.05 | Content                      |  0x0C     |
            | 4.00 | Bad Request                  |  0x0D     |
            | 4.01 | Unauthorized                 |  0x0E     |
            | 4.02 | Bad Option                   |  0x0F     |
            | 4.03 | Forbidden                    |  0x10     |
            | 4.04 | Not Found                    |  0x11     |
            | 4.05 | Method Not Allowed           |  0x12     |
            | 4.06 | Not Acceptable               |  0x13     |
            | 4.12 | Precondition Failed          |  0x14     |
            | 4.13 | Request Entity Too Large     |  0x15     |
            | 4.15 | Unsupported Content-Format   |  0x16     |
            | 5.00 | Internal Server Error        |  0x17     |
            | 5.01 | Not Implemented              |  0x18     |
            | 5.02 | Bad Gateway                  |  0x19     |
            | 5.03 | Service Unavailable          |  0x1A     |
            | 5.04 | Gateway Timeout              |  0x1B     |
            | 5.05 | Proxying Not Supported       |  0x1C     |
            +------+------------------------------+-----------+


</pre>
<p class="figure">Figure 1: CoAP code mapping</p>
<p id="rfc.section.2.2.1.1.p.5">This CDF can also be applied to path to send a reference instead of the path value.</p>
<h1 id="rfc.section.2.2.1.2"><a href="#rfc.section.2.2.1.2">2.2.1.2.</a> <a href="#remapping" id="remapping">Remapping</a></h1>
<p id="rfc.section.2.2.1.2.p.1">With dynamic mapping, the mapping is done dynamically, which means that the other end has no way to the learn the original value. This function is not conservative. The mapping context must be stored in a reliable way on the compressor, if lost the session with LPWAN node will be lost, which can generate a traffic increase on the LPWA network.</p>
<p id="rfc.section.2.2.1.2.p.2">This function converts a large number to a smaller one and maintain bi-directional mapping.  If the field has no semantic, such as a CoAP token or a message ID, this will reduce the size of the information sent on the link. This mapping only applies for request compression, answers must keep the value original value.</p>
<p id="rfc.section.2.2.1.2.p.3">For instance a compression receives a CoAP request with a large token. The compressor reduces the token size by allocating a unused value in a smaller space. When the response come back, the compressor exchange the smallest token with the original one.</p>
<p id="rfc.section.2.2.1.2.p.4">This mean that the compressor must be aware of the CoAP state machine, to identify a request and its associated response, but also determine when a token value can be reused.</p>
<h1 id="rfc.section.2.2.1.3"><a href="#rfc.section.2.2.1.3">2.2.1.3.</a> <a href="#reduce-entropy" id="reduce-entropy">Reduce-entropy</a></h1>
<p id="rfc.section.2.2.1.3.p.1">Reduce-entropy is a non-conservative function. the goal is to minimize the increase in a field value. It may be used for the observe option, all increase in the original sequence number will lead to an increase of 1 in the compressed value.</p>
<p id="rfc.section.2.2.1.3.p.2">For instance a LPWAN node is a CoAP server and receives Observe responses coming from an outside client. The client uses a clock to generate Observe sequence number. If that value has non particular meaning for the CoAP server, increase of 1 will not change the protocol behavior. Reordering works the same way as for original Observe.</p>
<h1 id="rfc.section.2.2.2"><a href="#rfc.section.2.2.2">2.2.2.</a> <a href="#coap-mandatory-header" id="coap-mandatory-header">CoAP mandatory header</a></h1>
<p><a href="#Fig--possible-function">Figure 2</a> proposes some function assignments to the CoAP header fields.</p>
<div id="rfc.figure.2"/>
<div id="Fig--possible-function"/>
<pre>
/--------------------+---------------------+----------------------------------------\
| Field              |Function             | Behavior                               |
+--------------------+---------------------+----------------------------------------+
|version             |not-sent             |version is always the same              |
+--------------------+---------------------+----------------------------------------+
|type                |value-sent           |if all the types are used               |
|                    |static-mapping       |to reduce to one bit if 2 type are used |
|                    |not-sent             |if only one type is used (e.g. NON)     |
+--------------------+---------------------+----------------------------------------+
|token length        |not-sent             |no tokens or fixed size                 |
|                    |compute-token-length |if token size is reduced                |
|                    |value-sent           |token is sent integrally                |
+--------------------+---------------------+----------------------------------------+
|code                |value-sent           |no modification                         |
|                    |static-mapping       |code size reduction                     |
+--------------------+---------------------+----------------------------------------+
|message id          |value-sent           |no modification                         |
|token               |remapping            |reduces message id size                 |
+====================+=====================+========================================+
|Content-Format      |value-sent           |no modification                         |
|Accept              |not-sent             |defined in the rule                     |
|Max-Age             |static-mapping       |map the possible value                  |
+--------------------+---------------------+----------------------------------------+
|Path:               |value-sent           |no modification                         |
|Uri-Host+Uri-Port+  |not-sent             |defined in the rule                     |
|Uri-Path*+Uri-Query*|static-mapping       |a value to define a path                |
|                    |                     |                                        |
|Proxy-Uri           |                     |Note: only the full path is stored in   |
|Proxy-Scheme        |                     |context                                 |
+--------------------+---------------------+----------------------------------------+
|ETag                |value-sent           |Always sent                             |
|Location-Path       |                     |                                        |
|Location-Query      |                     |                                        |
|If-Match            |                     |                                        |
|If-None-Match       |                     |                                        |
|Size1               |                     |                                        |
+--------------------+---------------------+----------------------------------------+

</pre>
<p class="figure">Figure 2: SCHC functions' example assignment for CoAP</p>
<h1 id="rfc.section.2.2.3"><a href="#rfc.section.2.2.3">2.2.3.</a> <a href="#examples-of-coap-header-compression" id="examples-of-coap-header-compression">Examples of CoAP header compression</a></h1>
<h1 id="rfc.section.2.2.3.1"><a href="#rfc.section.2.2.3.1">2.2.3.1.</a> <a href="#mandatory-header-with-con-message" id="mandatory-header-with-con-message">Mandatory header with CON message</a></h1>
<p id="rfc.section.2.2.3.1.p.1">In this first scenario, the LPWAN compressor receives from outside client a POST message, which is immediately acknowledged by the ES. For this simple scenario, the rules are described <a href="#Fig-CoAP-header-1">Figure 3</a></p>
<div id="rfc.figure.3"/>
<div id="Fig-CoAP-header-1"/>
<pre>
 rule id 1
+-------------+-------+-----+---------------+----------------+
| Field       |TV     |MO   |CDF            | Sent           |
+=============+=======+=====+===============+================+
|CoAP version | 01    |=    |not-sent       |                |
|CoAP Type    |       |     |value-sent     |TT              |
|CoAP TKL     | 0000  |=    |not-sent       |                |
|CoAP Code    |       |     |static-map     |  CC CCC        |
|CoAP MID     |       |     |dynamic-map    |         M-ID   |
|CoAP Path    |/path  |     |not-sent       |                |
+-------------+-------+-----+---------------+----------------+
</pre>
<p class="figure">Figure 3: CoAP Context to compress header without token</p>
<p><a href="#Fig-CoAP-header-1">Figure 3</a> gives a simple compression rule for CoAP headers without tokens.</p>
<p id="rfc.section.2.2.3.1.p.3">The version fields and Token Length are elided. Code has shrunk to 5 bits using the static-mapping function. Message-ID has shrunk to 9 bits to preserve alignment on byte boundary.</p>
<p><a href="#Fig-CoAP-3">Figure 4</a> shows the time diagram of the exchange. A LPWAN Application Server sends a CON message. Compression reduces the header sending only the Type, a mapped code and the Message ID is change to a value on 9 bits. The receiver decompress the header. The message ID value is changed.</p>
<p id="rfc.section.2.2.3.1.p.5">The CON message is a request, therefore the LC process to a dynamic mapping.  When the ES receives the ACK message, this will not initiate locally a the message ID mapping since it is a response. The LC receives the ACK and uncompress it to restore the original value. Dynamic Mapping context lifetime follows the same rules as message ID duration.</p>
<div id="rfc.figure.4"/>
<div id="Fig-CoAP-3"/>
<pre>
                   End System                      LPWA LC
                        |                            |
                        |        rule id=1           |&lt;----------------------
                        |&lt;---------------------------|   +-+-+--+----+--------+
  &lt;-------------------- |  TTCC CCCM MMMM MMMM       |   |1|0| 4|0.01| 0x1234 |
 +-+-+--+----+--------+ |  0000 0010 0000 0001       |   |  0xb4   p    a   t |
 |1|0| 1|0.01| 0x0001 | |                            |   |  h   |
 |  0xb4   p    a   t | |                            |   +------+
 |  h   |               |                            |    dynamic mapping
 +------+               |                            |    +--------+--------+
                        |                            |    |0x1234  |  0x01  |
                        |                            |    +--------+--------+
-----------------------&gt;|       rule id=1            |
+-+-+--+----+--------+  |---------------------------&gt;|
|1|2| 0|2.05| 0x0001 |  |    TTCC CCCM MMMM MMMM     |------------------------&gt;
+-+-+--+----+--------+  |    1000 0000 0000 0001     | +-+-+--+----+--------+
                        |                            | |1|2| 0|2.05| 0x1234 |
                        v                            v +-+-+--+----+--------+

</pre>
<p class="figure">Figure 4: Compression with global addresses</p>
<p id="rfc.section.2.2.3.1.p.6">Note that the compressor and decompressor must understand the CoAP protocol:</p>
<p/>

<ul>
  <li>The LC compressor detects a new transport request and allocate a new dynamic mapping value.</li>
  <li>When receiving a response the ES compressor ES detects that this is a response (type=2) therefore the message ID value in unchanged.</li>
  <li>The upstream compressor detects that is an REST answer (code 2.05) therefore the path option is not inserted in the uncompress header</li>
</ul>
<h1 id="rfc.section.2.2.3.2"><a href="#rfc.section.2.2.3.2">2.2.3.2.</a> <a href="#exchange-with-token" id="exchange-with-token">Exchange with token</a></h1>
<p id="rfc.section.2.2.3.2.p.1">The following scenario introduces tokens. The LC manages two remapping contexts.  One for Message ID and the other for token. ES manages one context for Message ID. Mapping is trigged by the reception of CON messages to compress or CoAP requests to compress. Note that the compressed message ID size has been reduced to 7 bits, compared to the previous example, to maintain byte boundary alignment.</p>
<div id="rfc.figure.5"/>
<div id="Fig-CoAP-header-2"/>
<pre>
  +----------------+------------------------+----------------+-----------------+
  | Field          |   Function             | Ctxt Value     | Sent compressed |
  +----------------+------------------------+----------------+-----------------+
  |CoAP version    | not-sent               |                |                 |
  |CoAP Type       | value-sent             |                |TT               |
  |CoAP TKL        | compute-token-length   |                |  LL             |
  |CoAP Code       | map-code               | mapping table  |      CCCC C     |
  |CoAP MID        | remapping              | 7 bits         |            M-ID |
  |CoAP Token      | remapping              | 8 bits         |            token|
  |CoAP Path       | not-sent               |/data/humidity  |
  +----------------+------------------------+----------------+-----------------+
</pre>
<p class="figure">Figure 5: CoAP Context to compress header with token</p>
<div id="rfc.figure.6"/>
<div id="Fig-CoAP-2"/>
<pre>
                   End System                      LPWA LC
                        |                            |
                        |        SHIM=1              |&lt;----------------------
                        |&lt;---------------------------|   +-+-+--+----+--------+
  &lt;-------------------- |  TT LL CCCC  C  MMMMMMM    |   |1|0| 4|0.01| 0x1234 |
 +-+-+--+----+--------+ |  00 01 0000  1  0000001    |   |      DEADBEEF      |
 |1|0| 1|0.01| 0x0001 | |  0000  0001                |   |  0xb4   d    a   t |
 |  01   0xb4   d   a | |  Token                     |   |   a     0x08 h   u |
 |    t   a    0x08 h | |                            |   |   m     i    d   i |
 |    u   m     i   d | |                            |   |   t     y  |
 |    i   t     y  |    |                            |   +------------+
 +-----------------+    |                            | Mid mapping: 1234 -&gt; 1
                        |                            | Tk  mapping: DEADBEEF -&gt; 1
-----------------------&gt;|       SHIM=1               |
+-+-+--+----+--------+  |---------------------------&gt;|
|1|2| 0|0.00| 0x0001 |  |    TT LL CCCC C MMMMMMMM   |------------------------&gt;
+-+-+--+----+--------+  |    10 01 0000 0 00000001   | +-+-+--+----+--------+
                        |                            | |1|2| 0|0.00| 0x1234 |
                        |                            | +-+-+--+----+--------+
-----------------------&gt;|                            |
+-+-+--+----+--------+  |---------------------------&gt;|
|1|0| 0|2.05| 0xCAFE |  |    TT LL CCCC C MMMMMMMM   |------------------------&gt;
| 0x01    2     5    |  |    00 01 1100 0 00000002   | +-+-+--+----+--------+
+--------------------+  |    0000  0001              | |1|0| 4|2.05| 0x0001 |
                        |    2 5                     | |       DEADBEEF     |
                        |                            | |    2    5 |
Mid mapping: CAFE -&gt; 1  |                            | +-----------+
                        |                            |
                        |                            |&lt;------------------------
                        |&lt;---------------------------| +-+-+--+----+--------+
&lt;-----------------------|     TT LL CCCC C  MMMMMMMM | |1|2| 0|0.00|0x0001  |
+-+-+--+----+--------+  |     10 00 0000 0  00000002 | +-+-+--+----+--------+
|1|2| 0|0.00| 0xCAFE |  |                            |
+-+-+--+----+--------+  |                            |
                        v                            v


</pre>
<p class="figure">Figure 6: Compression with token</p>
<h1 id="rfc.references"><a href="#rfc.references">3.</a> Normative References</h1>
<table>
  <tbody>
    <tr>
      <td class="reference">
        <b id="I-D.toutain-lpwan-ipv6-static-context-hc">[I-D.toutain-lpwan-ipv6-static-context-hc]</b>
      </td>
      <td class="top"><a>Minaburo, A.</a> and <a>L. Toutain</a>, "<a href="http://tools.ietf.org/html/draft-toutain-lpwan-ipv6-static-context-hc-00">LPWAN Static Context Header Compression (SCHC) for IPv6 and UDP</a>", Internet-Draft draft-toutain-lpwan-ipv6-static-context-hc-00, September 2016.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC1332">[RFC1332]</b>
      </td>
      <td class="top"><a>McGregor, G.</a>, "<a href="http://tools.ietf.org/html/rfc1332">The PPP Internet Protocol Control Protocol (IPCP)</a>", RFC 1332, DOI 10.17487/RFC1332, May 1992.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC3095">[RFC3095]</b>
      </td>
      <td class="top"><a>Bormann, C.</a>, <a>Burmeister, C.</a>, <a>Degermark, M.</a>, <a>Fukushima, H.</a>, <a>Hannu, H.</a>, <a>Jonsson, L-E.</a>, <a>Hakenberg, R.</a>, <a>Koren, T.</a>, <a>Le, K.</a>, <a>Liu, Z.</a>, <a>Martensson, A.</a>, <a>Miyazaki, A.</a>, <a>Svanbro, K.</a>, <a>Wiebke, T.</a>, <a>Yoshimura, T.</a> and <a>H. Zheng</a>, "<a href="http://tools.ietf.org/html/rfc3095">RObust Header Compression (ROHC): Framework and four profiles: RTP, UDP, ESP, and uncompressed</a>", RFC 3095, DOI 10.17487/RFC3095, July 2001.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC4944">[RFC4944]</b>
      </td>
      <td class="top"><a>Montenegro, G.</a>, <a>Kushalnagar, N.</a>, <a>Hui, J.</a> and <a>D. Culler</a>, "<a href="http://tools.ietf.org/html/rfc4944">Transmission of IPv6 Packets over IEEE 802.15.4 Networks</a>", RFC 4944, DOI 10.17487/RFC4944, September 2007.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC4997">[RFC4997]</b>
      </td>
      <td class="top"><a>Finking, R.</a> and <a>G. Pelletier</a>, "<a href="http://tools.ietf.org/html/rfc4997">Formal Notation for RObust Header Compression (ROHC-FN)</a>", RFC 4997, DOI 10.17487/RFC4997, July 2007.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC5225">[RFC5225]</b>
      </td>
      <td class="top"><a>Pelletier, G.</a> and <a>K. Sandlund</a>, "<a href="http://tools.ietf.org/html/rfc5225">RObust Header Compression Version 2 (ROHCv2): Profiles for RTP, UDP, IP, ESP and UDP-Lite</a>", RFC 5225, DOI 10.17487/RFC5225, April 2008.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC6282">[RFC6282]</b>
      </td>
      <td class="top"><a>Hui, J.</a> and <a>P. Thubert</a>, "<a href="http://tools.ietf.org/html/rfc6282">Compression Format for IPv6 Datagrams over IEEE 802.15.4-Based Networks</a>", RFC 6282, DOI 10.17487/RFC6282, September 2011.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC7252">[RFC7252]</b>
      </td>
      <td class="top"><a>Shelby, Z.</a>, <a>Hartke, K.</a> and <a>C. Bormann</a>, "<a href="http://tools.ietf.org/html/rfc7252">The Constrained Application Protocol (CoAP)</a>", RFC 7252, DOI 10.17487/RFC7252, June 2014.</td>
    </tr>
    <tr>
      <td class="reference">
        <b id="RFC7967">[RFC7967]</b>
      </td>
      <td class="top"><a>Bhattacharyya, A.</a>, <a>Bandyopadhyay, S.</a>, <a>Pal, A.</a> and <a>T. Bose</a>, "<a href="http://tools.ietf.org/html/rfc7967">Constrained Application Protocol (CoAP) Option for No Server Response</a>", RFC 7967, DOI 10.17487/RFC7967, August 2016.</td>
    </tr>
  </tbody>
</table>
<h1 id="rfc.authors">
  <a href="#rfc.authors">Authors' Addresses</a>
</h1>
<div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Ana Minaburo</span> 
	  <span class="n hidden">
		<span class="family-name">Minaburo</span>
	  </span>
	</span>
	<span class="org vcardline">Acklio</span>
	<span class="adr">
	  <span class="vcardline">2bis rue de la Chataigneraie</span>

	  <span class="vcardline">
		<span class="locality">35510 Cesson-Sevigne Cedex</span>,  
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline">France</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:ana@ackl.io">ana@ackl.io</a></span>

  </address>
</div><div class="avoidbreak">
  <address class="vcard">
	<span class="vcardline">
	  <span class="fn">Laurent Toutain</span> 
	  <span class="n hidden">
		<span class="family-name">Toutain</span>
	  </span>
	</span>
	<span class="org vcardline">Institut MINES TELECOM ; TELECOM Bretagne</span>
	<span class="adr">
	  <span class="vcardline">2 rue de la Chataigneraie</span>
<span class="vcardline">CS 17607</span>

	  <span class="vcardline">
		<span class="locality">35576 Cesson-Sevigne Cedex</span>,  
		<span class="region"></span>
		<span class="code"></span>
	  </span>
	  <span class="country-name vcardline">France</span>
	</span>
	<span class="vcardline">EMail: <a href="mailto:Laurent.Toutain@telecom-bretagne.eu">Laurent.Toutain@telecom-bretagne.eu</a></span>

  </address>
</div>
  
  <hr class="noprint" />
  <h1 class="np" id="rfc.toc"><a href="#rfc.toc">Table of Contents</a></h1>
  <ul class="toc">

  	<li>1.   <a href="#rfc.section.1">Introduction</a></li>
<li>2.   <a href="#rfc.section.2">Compressing CoAP</a></li>
<ul><li>2.1.   <a href="#rfc.section.2.1">CoAP usages</a></li>
<li>2.2.   <a href="#rfc.section.2.2">CoAP protocol analysis</a></li>
<ul><li>2.2.1.   <a href="#rfc.section.2.2.1">CoAP Compression Decompression Function</a></li>
<li>2.2.2.   <a href="#rfc.section.2.2.2">CoAP mandatory header</a></li>
<li>2.2.3.   <a href="#rfc.section.2.2.3">Examples of CoAP header compression</a></li>
</ul></ul><li>3.   <a href="#rfc.references">Normative References</a></li>
<li><a href="#rfc.authors">Authors' Addresses</a></li>


  </ul>

  

</body>
</html>
